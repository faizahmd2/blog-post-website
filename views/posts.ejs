<%- include('partials/_header') -%>

<!-- Simple Pagination css -->
<!-- <link rel="stylesheet" href="vendor/jquery/css/simplePagination.min.css"> -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simplePagination.js/1.6/simplePagination.min.css" integrity="sha512-m3x+GduGUoEMGB6dywpah/mAG3GafMmxmByGLqKfZFF8xr6THjjOcH0OWV1rLBFiZMotecZxWhRz0lVlVNl72w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="css/posts.css">

<body class="background-image" style="overflow: hidden;">
<%- include('partials/_navigation', { user }) -%>

  <div class="posts">
    <div class="input-group mb-3 search">
      <div class="input-search-parent">
        <input id="search" type="text" class="form-control" placeholder="Search..." aria-label="Search" aria-describedby="button-addon2">
        <span id="clearSearch" class="clear-search">&times;</span>
      </div>
      <button class="btn btn-primary" type="button" id="button-addon2">Search</button>
    </div>
    <div class="posts-container">
      <div id="all-posts" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-1">
        <% posts.forEach(post => { %>
          <div class="col">
            <a href="#" class="disable-anchor-css">
              <div class="card mb-2">
                  <h5 class="card-title-text"><%= post.title %></h5>
                  <p class="mb-1 card-plain-text"><%= post.plainTextContent.slice(0, 172) + (post.plainTextContent.length > 172 ? "..." : "") %></p>
              </div>
            </a>
          </div>
        <% }); %>
      </div>
    </div>
  </div>
  <div class="pagination-container">
    <div id="pagination"></div>
  </div>

  <!-- Simple Pagination js -->
  <!-- <script src="/public/vendor/jquery/js/jquery.min.js"></script> -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/simplePagination.js/1.6/jquery.simplePagination.min.js" integrity="sha512-9Dh726RTZVE1k5R1RNEzk1ex4AoRjxNMFKtZdcWaG2KUgjEmFYN3n17YLUrbHm47CRQB1mvVBHDFXrcnx/deDA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="js/utility.js"></script>
  <script>
    let totalPosts = '<%= totalPosts %>';
    let postsPerPage = '<%= postsPerPage %>';
    let totalPage = '<%= totalPage %>';
    let currentPage = '<%= currentPage %>';
    const debouncedListChange = debounce(handleListChange, 600);

    $(document).ready(function(){
      // Initialize pagination
      if(totalPage > 1) {
        initPagination(totalPosts, totalPage, postsPerPage, currentPage);
      }

      $("#search").on("input", function() {
        debouncedListChange(this.value,"");
      });

      $("#clearSearch").on("click", function() {
        handleListChange("", "");
        $("#search").val("");
      })
    });

    function handleListChange(search, page) {
      showLoader();
      setSearchQueryParam({"search": search, "page": page});
      getPostsByApi().then(response => {
        appendPostsCard(response);
          hideLoader();
      });
    }

    async function getPostsByApi() {
      let url = "/posts" + window.location.search;

      let response = await fetchData(url);

      if(response.error) return notify.error(response.error);

      if(!response.success) return notify.error("Some error occured");

      return response;
    }

    function initPagination(items, pages, itemsOnPage, currentPage=1) {
      $('#pagination').pagination({
        items: items,
        itemsOnPage: itemsOnPage,
        currentPage: currentPage,
        displayedPages: 3,
        cssStyle: 'light-theme',
        onPageClick: function(pageNumber, event) {
          event.preventDefault();
          debouncedListChange($("#search").val(), pageNumber);
        }
      });
    }

    function appendPostsCard(response) {
      const parentDiv = document.getElementById('all-posts');
      parentDiv.innerHTML = '';
      for(let post of response.posts) {
        let template = getPostCardHtml(post);
        $('#all-posts').append(template);
      }
    }

    function getPostCardHtml(post) {
      return `<div class="col">
        <a href="#" class="disable-anchor-css">
          <div class="card mb-2">
              <h5 class="card-title-text">${post.title}</h5>
              <p class="card-plain-text">${post.plainTextContent.slice(0, 172) + (post.plainTextContent.length > 172 ? "..." : "")}</p>
          </div>
        </a>
      </div>`
    }

  </script>
</body>


